from concurrent.futures import ThreadPoolExecutor, as_completed
from typing import Dict, List

from json_utils import extract_json_fragment as _extract_json_fragment
from llm_client import LLMClient


def _calculate_overall_evaluation(labels: List[str]) -> str:
    """
    good/neutral/bad 라벨을 점수화해 최종 등급(A~E)을 계산한다.
    점수 매핑: good=+1, neutral=0, bad=-1
    """
    if not labels:
        return "E"

    score_map = {"good": 1, "neutral": 0.4, "bad": -1}
    avg_score = sum(score_map.get(label, 0) for label in labels) / len(labels)

    if avg_score >= 0.7:
        return "A"  # 거의 대부분이 사용자 친화적
    if avg_score >= 0.4:
        return "B"  # good 우세, bad 적음
    if avg_score >= 0.0:
        return "C"  # 중립적이거나 균형
    if avg_score >= -0.4:
        return "D"  # bad가 다소 많음
    return "E"  # bad가 대부분


# 1) 카테고리별 평가 포인트 텍스트만 따로 정의
#    아래 각 문자열 안에, 이전에 설계한 카테고리별 상세 평가 기준을 그대로 옮겨 넣으면 된다.
CATEGORY_EVAL_POINTS: Dict[str, str] = {
    "계정 관리 및 가입 조건": """
<핵심 체크포인트>
1. 누가 가입/이용할 수 있는지(연령, 지역, 자격) 명확한지
2. 계정 정지·해지 사유와 절차(사전 통지, 시정 기회, 항변/이의제기)
3. 휴면 계정·장기 미사용 처리, 유료 자산(포인트, 리워드, 콘텐츠) 소멸 방식

<good 패턴>
- 법령에 맞는 연령 제한(예: 미성년자는 보호자 동의 필요 등)을 명확히 안내
- 구체적인 위반 사유(불법행위, 타인 피해, 보안 위협 등)에 대해서만 계정 정지·해지 가능
  - 가능하면 단계별 제재(경고 → 일시정지 → 해지)
  - 시정 기간 제공(Temu처럼 7일 내 시정 요구 후 해지 가능)
- 서비스 중단·계약 종료 시 합리적 사전 통지, 데이터 백업/이전 기회 제공
- 휴면 계정 처리도 일정 기간, 통지 방법, 데이터 삭제 범위 명확, 일정 기간 내 재로그인 시 복구 가능

<neutral 패턴>
- 회사의 “합리적 재량”으로 계정을 정지·해지할 수 있다고 하지만 대표적인 사유 예시가 있고, 위반행위와 제재 수준이 크게 지나치지 않음
- 휴면 계정 전환 시 통지 + 일정 기간 미사용 계정 삭제, 포인트/리워드는 계약 당시 안내된 유효기간 내에서 소멸

<bad 패턴>
- 사유 불문, 사전 통지 없이 언제든지 즉시 계정을 해지할 수 있다고 규정
  - 예: “사업자가 급부(서비스 제공)를 상당한 이유 없이 일방적으로 중지/변경할 수 있게 하는 조항”
- 경미한 위반 또는 전혀 귀책사유가 없어도, 계정 해지 시 유료 콘텐츠·포인트·리워드 전부 소멸, 환불/보상 일절 불가라고 하는 경우
- 휴면 계정을 이유로 사전 통지 없이 계정 및 데이터 영구 삭제
""",
    "결제 및 환불 규정": """
<핵심 체크포인트>
1. 요금·수수료·세금·추가 비용이 얼마나 명확하게 설명되는지
2. 자동 결제·구독 갱신·무료 체험 후 유료 전환이 눈에 띄게 공지되는지
3. 환불·청약철회·계약 해제/해지 권리를 어떻게 제한/보장하는지
4. 위약금·손해배상액·취소 수수료가 “과도한 수준”인지 (약관심사지침 법 제8조)

<good 패턴>
- 결제 금액 구성(상품가, 세금, 배송비, 수수료)과 청구 시점이 명확
- 구독/자동 갱신: 무료 체험 후 언제부터 유료 전환되며, 전환 전까지 언제든지 해지 가능함을 분명히 고지
- 환불: 법정 청약철회 기간 이상을 보장하거나, “결제 후 7일 이내, 콘텐츠 미시청 시 전액 환불 가능” 등 추가 권리 제공
- 위약금·취소 수수료가 통상의 거래 관행(대략 10% 수준 등) 안에서 합리적인 편, 사업자 귀책 시에는 오히려 사용자에게 유리한 구조

<neutral 패턴>
- “결제 후 환불 불가, 다만 법령 또는 별도 환불 정책에서 정한 경우는 예외” 구조
- 자동결제/자동갱신이지만 약관·가입 화면에서 그것을 명시하고, 사용자가 설정에서 언제든 해지 가능(다음 결제 주기부터 중단)

<bad 패턴>
- 모든 결제 금액에 대해 일체 환불 불가, 심지어 법에서 보장하는 청약철회/해제권까지 “불가”라고 단정하는 경우
  - 지침이 예시로 드는 “수강료 전액 미환불 조항”과 유사
- 사업자 귀책(오류, 서비스 중단 등)인데도 환불/보상 책임을 전면 부정
- 취소할 때, 거래대금 대비 과도한 위약금(20~30% 이상 등)을 부과
- 무료 체험이라면서 실제로는 자동 유료 전환을 눈에 띄게 알리지 않고, 해지 절차도 과도하게 복잡
""",
    "개인정보 및 데이터 수집": """
<핵심 체크포인트>
1. 어떤 개인정보/행태 데이터(로그, 위치, 기기정보 등)를 어디까지 수집하는지
2. 수집 목적(서비스 제공 vs 광고/제3자 제공)이 구체적인지
3. 보관 기간·파기 기준, 이용자 권리(열람·정정·삭제·처리정지·마케팅 거부 등)
4. 제3자 제공·광고 네트워크·분석 도구와의 데이터 공유 범위

<good 패턴>
- 서비스 제공에 필요한 정보 + 최소한의 분석/보안 목적 위주로 수집
- 민감/행태 데이터(정밀 위치, 연락처 목록, 광고 ID 등)는 별도의 동의 또는 명시적 옵트아웃(마케팅 문자/이메일 수신 거부 등) 제공.
- 보관 기간을 목적별로 구분해 명시(계정 유지 기간, 법적 보관 의무 등)하고, 계정 삭제 시 상당 부분 삭제
- 이용자에게 개인정보 열람/수정/삭제/처리정지/프로파일링 거부 등 권리 부여, 마케팅 수신 거부를 쉽게 할 수 있게 함

<neutral 패턴>
- “서비스 제공, 개선, 맞춤형 광고 제공” 등 포괄적인 목적을 두지만, 개인정보 처리방침을 통해 기본적인 정보(항목/목적/보관기간/제3자 제공)를 공개
- 제3자 광고/분석 도구와 일정 데이터 공유하나, 정책에서 명시하고, 최소한 마케팅 수신은 거부할 수 있음

<bad 패턴>
- 서비스 이용과 상관없는 광범위한 개인정보(연락처 전체, 다른 서비스 계정 정보 등)를 포괄 동의 한 번으로 수집/판매
- 제3자(광고업체, 데이터 브로커)에게 무제한으로 제공/판매하면서, 이용자가 이를 통제하거나 알아볼 방법이 거의 없음
- 계정 삭제 후에도 “영구적으로 보관·자유롭게 이용”할 수 있다고 되어 있으며, 법적 의무와 무관하게 폭넓은 2차 이용을 허용
- 마케팅 문자/이메일 수신이 사실상 서비스 이용의 필수 조건이어서 거부하면 서비스를 제대로 못 씀(예: “거부하면 서비스 이용에 영향”)
""",
    "이용자 콘텐츠의 라이선스": """
<핵심 체크포인트>
1. 소유권은 누구에게 있고, 사업자가 받는 라이선스의 범위·기간·목적
2. 2차적 저작물 생성·광고/홍보 활용 범위
3. 계정 삭제/콘텐츠 삭제 후에도 라이선스가 계속되는지

<good 패턴>
- “콘텐츠의 저작권은 회원에게 있으며, 회사는 서비스 제공 및 운영에 필요한 범위 내에서만 비독점적 라이선스를 가진다” 구조
- 광고·홍보에 활용할 때도 서비스·회사 홍보에 한정, 회원이 삭제하면 앞으로의 사용을 중단
- 계정 삭제/콘텐츠 삭제 시, 백업/법적 의무 범위를 제외하고는 라이선스가 종료된다고 명시

<neutral 패턴>
- 세계적·무상·양도가능·서브라이선스 가능 등 꽤 넓은 라이선스를 부여하지만, “서비스 제공·운영·개선·서비스 홍보”와 같은 한정된 목적으로 쓰겠다고 밝힘
- 삭제 후에도 이미 공유된 범위 내에서는 계속 사용할 수 있다고 하나, 새로운 이용/2차 판매에 대해서는 제한

<bad 패턴>
- “영구적, 취소 불가, 전세계적, 양도·재라이선스 가능, 어떠한 목적(상업적 판매 포함)으로도 사용할 수 있다” 식의 무제한 라이선스를 요구
- 계정 삭제·콘텐츠 삭제 후에도, 별다른 제한 없이 여전히 모든 용도로 사용할 수 있다고 함
- 이용자 콘텐츠를 회사가 별도 보상 없이 2차 저작물·상품으로 만들어 판매할 수 있고, 이용자가 이를 중단시킬 권리가 전혀 없는 구조
""",
    "금지사항": """
<핵심 체크포인트>
1. 금지행위가 불법행위·타인 피해·보안 위협 등 필수적인 것에 집중되어 있는지
2. 회사/서비스에 대한 비판·집단행동·권리 행사 등을 부당하게 막는 조항이 있는지

<good 패턴>
- 금지행위 목록이 불법 컨텐츠, 지식재산권 침해, 스팸·해킹, 개인정보 침해, 괴롭힘·혐오표현 등 정당한 목적에 집중
- 위반 시 조치(게시물 삭제, 일시정지, 해지 등)를 위반의 정도에 비례해 단계적으로 두고, 필요시 사용자에게 통지/소명 기회 부여

<neutral 패턴>
- 금지행위 항목이 꽤 많지만, 대부분은 서비스 안정·타인 보호를 위한 일반적 내용
- 다소 추상적인 표현(“이용자에게 불편을 주는 행위” 등)이 섞여 있지만, 시정 요청이나 경고 후 조치를 취한다고 안내

<bad 패턴>
- 헌법상 보장된 집회·결사의 자유나 단체행동을 막는 조항 (지침 예시: “사업자 허락 없이 단체를 구성하거나 집단행위에 참가할 수 없다” 조항)
- 서비스·회사에 대한 비판, 리뷰, 소비자운동, 소송 제기 등을 사실상 금지하거나 보복하겠다는 내용
- 위반 여부와 무관하게, 사업자가 임의로 게시물을 삭제·계정을 영구 정지할 수 있고, 사용자에게 항변 기회가 전혀 없는 구조
""",
    "약관 및 서비스 변경": """
<핵심 체크포인트>
1. 사업자가 무엇을 얼마나 폭넓게 변경할 수 있는지 (가격/핵심 서비스/기능 등)
2. “상당한 이유”가 있는 경우로 제한되어 있는지, 아니면 포괄적으로 언제든 변경 가능한지
3. 변경 시 사전 통지, 동의/거부권, 해지권 보장 여부

<good 패턴>
- 가격·요금제 변경 시 사전 통지 + 동의 절차, 동의하지 않으면 위약금 없이 해지 가능
- 서비스 기능 변경도 불가피한 이유(법령 변경, 보안, 기술적 필요 등)를 근거로 하고, 이용자에게 통지 후 적용
- 약관 변경 시 개정일·적용일 명시, 중요한 변경은 공지 + 이메일 등 개별 통지, 사용자가 변경에 동의하지 않을 경우 손해 없이 해지할 수 있음

<neutral 패턴>
- “회사는 필요시 약관을 변경할 수 있으며, 변경 약관을 공지하고, 적용일 이후 서비스 이용 시 동의한 것으로 본다”
  - 다만, 중요한 내용에서는 어느 정도 상세 안내를 하는 정도
- 서비스 내용 일부(이벤트, 부가 기능 등)는 사정에 따라 변경·중단 가능하다고 하나, 핵심 급부는 유지

<bad 패턴>
- 약관심사지침의 불공정 예시에 가깝게:
  - “상가의 용도, 구조, 위치 등 계약의 중요한 사항을 상대방 동의 없이 사업자가 임의로 변경”
  - “카드사·포인트 서비스 등을 사업자 사정에 따라 사전 예고 없이 변경·취소”
  - “게임 서비스를 이용자 동의 없이 필요에 따라 수시로 수정 또는 삭제” 등
- 서비스의 핵심 기능·요금·제한 등을 아무 제약 없이 언제든지 변경/중단 가능하다고만 적고, 사용자에게 통지·해지권을 사실상 주지 않는 경우
- 변경 내용을 소급 적용(과거 이용에도 불리하게)하겠다는 내용
""",
    "책임 제한 및 면책": """
<핵심 체크포인트>
1. 어떤 손해에 대한 책임을 제한하는지(직접/간접/특별손해 등)
2. 사업자의 고의·중과실에 대해서까지 책임을 배제하는지(지침상 금지)
3. 사용자에게 과도한 자기 책임/면책을 떠넘기는지

<good 패턴>
- 지침에 맞게, 고의·중과실, 법이 강행적으로 정한 책임(생명·신체·중대 재산 피해 등)에 대해서는 책임을 인정
- 서비스의 특성상 “간접·결과적·특별 손해”, “예측 불가능한 손해”에 대해서는 합리적 한도 내에서만 책임을 제한
- 데이터 손실·서비스 장애 발생 시 복구 시도, 최소한의 보상(사용료 환불 등)을 인정

<neutral 패턴>
- “서비스는 ‘있는 그대로’ 제공되고, 법이 허용하는 최대한도로 책임을 제한한다”는 표준적인 문구로,
  - 하지만 고의·중과실, 법령상 책임은 제외한다고 적어둔 경우
- 간접손해·특수손해는 책임 제한하지만, 직접적인 손해·사용료 상당액 정도는 책임 인정

<bad 패턴>
- 약관심사지침 제7조 위반 유형처럼:
  - 사업자 또는 피용자의 고의·중과실로 인한 손해도 책임을 지지 않는다고 명시
- 시스템 오류, 개인정보 유출, 결제 오작동 등 일반인의 상식상 사업자 책임이 있어야 할 영역에 대해서도 전면 면책
- 사용자의 귀책 여부와 무관하게, 모든 손해를 사용자 부담으로 돌리거나, 소송비용까지 전부 고객이 부담하게 하는 조항 (지침 예시: 승패와 관계없이 소송비용 일체를 고객이 부담)
""",
    "분쟁 해결 및 준거법": """
<핵심 체크포인트>
1. 준거법(어느 나라 법 적용) 규정이 소비자에게 얼마나 불리한지
2. 관할법원·중재조항·소송금지·집단소송 포기 여부

<good 패턴>
- 소비자인 경우에는 거주국 법률과 거주지 관할법원이 적용된다고 명시
- 재판관할을 정하더라도 소비자에게 “선택권”(거주지 또는 특정 법원 중 선택) 부여
- 중재 조항이 있다 하더라도, 소비자에게 소송/중재를 선택할 권리를 주거나, 최소한 필수 중재는 중대한 사건(신체·중대한 재산 피해)에만 한정

<neutral 패턴>
- 글로벌 서비스에서 많이 쓰는 구조:
  - 준거법은 특정국 법(예: 캘리포니아주법), 관할은 그 지역 법원으로 정하되, “소비자 보호 강행규정이 있는 경우에는 소비자 거주지 법률이 우선”이라고 명시
- 중재조항이 있지만, 소액 사건/특정 분쟁에만 적용하거나, 일정 조건에서 법원 소송이 가능

<bad 패턴>
- 약관심사지침 “소송 제기의 금지 등” 유형처럼:
  - “어떠한 경우에도 법원에 소송을 제기할 수 없고, 회사가 지정한 중재만 가능”
  - “집단소송, 단체소송, 배심재판을 모두 포기”
- 전속관할을 소비자에게 극도로 불리한 곳(지리적으로 먼 국가, 사실상 접근 불가)에만 두고, 예외·선택권이 전혀 없음
- 분쟁 발생 시 소멸시효를 일반 법보다 매우 짧게(예: 3개월 이내 제기하지 않으면 모든 권리 소멸) 줄이는 조항
""",
    "제3자 서비스": """
<핵심 체크포인트>
1. 소셜 로그인, 외부 결제, 제3자 앱/플랫폼 연동 시 제3자 약관·정책이 어떻게 적용되는지
2. 제3자 컨텐츠/링크에 대한 책임 범위를 어디까지 면책하는지
3. 제3자와의 데이터 공유 구조

<good 패턴>
- “링크된 제3자 웹사이트의 내용과 개인정보 처리에 대해서는 제3자 정책이 적용되며, 우리는 이를 상세하게 안내하지만 고의·중과실에 의한 손해에 대해서는 일정 책임을 진다”고 균형 있게 설명
- 소셜 로그인·외부 결제 사용 여부를 사용자가 선택 가능, 이용 시 어떤 정보가 어떤 제3자에게 전송되는지 안내

<neutral 패턴>
- “제3자 사이트/서비스에 대한 책임은 해당 제3자가 부담하며 우리는 링크 제공에 불과하다”는 일반적인 면책
  - 단, 사업자의 고의·중과실에 따른 잘못된 연결/안내는 별도로 책임진다고 보거나, 최소한 “법이 허용하는 범위 내에서”라고 한정

<bad 패턴>
- 서비스 핵심 기능이 특정 제3자에게 사실상 종속되어 있음에도, 제3자의 모든 행위/과실에 대해 자사는 전면 면책, 이용자는 제3자와 별도로 해결하라는 식으로만 처리
- 제3자 SDK·광고 네트워크 등에 이용자의 개인정보·행태 데이터를 광범위하게 넘기면서, 제대로 된 안내/동의/통제권을 제공하지 않음
""",
    "기타": """
- 카테고리에 명확히 들어가지 않는 기타 카테고리 조항은 공통 평가 관점만 적용하여 평가합니다.
""",
}


# 2) 공통 system_instruction (카테고리 공통 부분)
BASE_SYSTEM_INSTRUCTION = """
[시스템 지시]
당신은 온라인 서비스 이용약관이 일반 소비자(이용자)에게 유리한지/불리한지를 평가하는 전문가입니다.

입력으로는
- 하나의 카테고리 이름
- 해당 카테고리에 속하는 약관 요약 문단(한국어)
이 주어집니다.

이 요약은 이미 여러 조항을 이해하기 쉽게 풀어 쓴 것이므로, 원문을 상상해서 보충 설명을 만들지 말고
요약에 드러난 내용만 근거로 평가해야 합니다.

[입력 형식]
- 사용자 메시지는 항상 "[카테고리]\n<카테고리 이름>\n\n[입력 요약 조항]\n<요약 텍스트>" 형식입니다.

[출력 형식]
- 아래 JSON 객체 한 개만 출력해야 합니다.
- 키 순서는 반드시 reasoning → label 순서를 지키십시오.
- JSON 앞뒤에 설명/코드블록/주석을 넣지 마십시오.

{
  "reasoning": "판단 근거를 한국어로 2~4문장 정도로 요약",
  "label": "good" | "neutral" | "bad"
}

[label 의미]
- good:
  - 이용자 권리·선택권·정보제공을 강화하거나, 법령·심사지침상 바람직한 보호 기준을 넘는 조항
  - 통상적 수준의 불이익은 있을 수 있으나, 그에 상응하는 이용자 보호·절차·통제권이 충분히 부여된 경우
- neutral:
  - 업계에서 흔히 보는 “표준 약관” 수준
  - 어느 정도 사업자에게 유리하긴 하지만, 법이 명시적으로 금지한 수준까진 아니고, 소비자가 그 정도는 어느 정도 예상할 수 있는 범위
  - 긍정·부정 요소가 섞여 전반적으로 중간 수준으로 보이는 경우
  - 예: “부분 기간에 대한 환불은 원칙적으로 하지 않음, 다만 법이 요구하는 경우에는 환불”
- bad:
  - 약관심사지침이 예시로 드는 불공정 유형에 직접 걸리거나 그에 준할 정도로 사용자 권리/구제수단을 줄이고, 사업자에게 일방적인 결정권·면책·과중한 위약금 등을 주는 조항
  - 일반 이용자가 전혀 예상 못할 핵심 불이익(소송권 포기, 계약 해지 못하게 함 등)을 숨기는 내용

[공통 평가 관점]
모든 카테고리에 공통으로 아래 네 가지 관점을 함께 고려합니다.

1) 내용 편향성
  - 사업자 권한만 과도하게 넓고 이용자 권리·구제수단이 약한지
2) 위험·영향 정도
  - 이용자에게 돌아가는 금전적 손실, 계정/데이터 상실, 법적 위험이 어느 정도인지
3) 통제·선택권
  - 이용자가 동의/거절/해지/철회/설정 변경 등을 현실적으로 할 수 있는지, 절차가 합리적인지
4) 명확성·투명성
  - 적용 요건, 범위, 예외, 절차, 기간 등이 이용자 기준에서 충분히 구체적·명확하게 설명되는지

이제 해당 카테고리에서 어떤 점을 특히 중점적으로 볼지 정의합니다.

[현재 카테고리 평가 포인트]{category_eval_points}

[평가 절차]
1단계: 평가 기준 숙지
  - 공통 평가 관점(편향성·위험도·통제·투명성)과 현재 카테고리 평가 포인트(good/neutral/<bad 패턴>)를 차분히 읽고, 각각이 어떤 조항에 해당하는지, 어떤 요소가 있으면 이용자에게 유리/불리로 보는지 머릿속에 정리합니다.
2단계: 요약 조항 분석
  - 입력 요약 조항을 천천히 읽고, 아래를 점검합니다.
    - (a) <good 패턴>에 해당하는 보호 장치·권리·절차가 있는지
    - (b) <bad 패턴>에 해당하는 과도한 사업자 재량·면책·권리 포기·과중한 부담이 있는지
    - (c) 그 외 일반적인 업계 관행 수준(neutral)으로 볼 만한지
  - 이때, 공통 평가 관점(편향성, 위험 크기, 통제·선택권, 명확성·투명성)을 함께 떠올리며, 이용자에게 주는 이익/보호 요소와 이용자에게 주는 불이익/위험 요소를 각각 구분해 정리합니다.
3단계: reasoning 작성
  - 위에서 정리한 내용을 바탕으로, 아래 내용을 3~5문장 안에 명시적으로 설명합니다.
    - 이 조항이 이용자에게 어떤 이익(또는 보호·권리 강화)을 주는지,
    - 어떤 불이익·위험(또는 권리 제한·의무 가중·정보 비대칭)을 유발하는지,
    - 그 수준이 good/neutral/<bad 패턴> 중 어디에 더 가까운지, 그리고 그 이유가 무엇인지
  - 특히 <bad 패턴>과 유사한 요소가 있는 경우, 어떤 점이 왜 위험한지 구체적으로 짚어 줍니다.
  - 반대로 <good 패턴> 요소가 강한 경우, 이용자 입장에서 어떤 점이 보호 장치로 작동하는지 분명히 적습니다.
4단계: label 선택
  - reasoning에서 설명한 근거를 토대로, good/neutral/bad 중 하나를 선택합니다.

[주의사항]
- 평가 절차의 2단계의 내용은 출력하지 않고, 반드시 3단계의 reasoning과 4단계의 label만 JSON 형식으로 출력하십시오.
"""


def _build_system_instruction_for_category(category: str) -> str:
    eval_points = CATEGORY_EVAL_POINTS.get(
        category, CATEGORY_EVAL_POINTS.get("기타", "")
    )
    system_instruction = BASE_SYSTEM_INSTRUCTION.replace(
        "{category_eval_points}", eval_points
    )

    return system_instruction + f"""

[카테고리]
{category}
"""


def evaluate_summary(category: str, summary: str, client: LLMClient) -> Dict:
    """
    단일 요약 조항과 카테고리에 대해,
    공정위 약관심사지침 취지를 반영한 카테고리별 기준으로
    good/neutral/bad + reasoning을 생성한다.
    """
    system_instruction = _build_system_instruction_for_category(category)

    message = f"[입력 요약 조항]\n{summary}"
    response = client.generate_response(system_instruction, message)

    # 기대 형식:
    # {
    #   "reasoning": "...",
    #   "label": "good" | "neutral" | "bad"
    # }
    return _extract_json_fragment(response)


def evaluate_category_summaries(
    category_summaries: List[Dict], client: LLMClient
) -> Dict:
    """
    카테고리별 요약을 평가하고 전체 약관 등급(A~E)을 계산한다.
    category_summaries: [{ "category": str, "summary": str }, ...]
    """
    if not category_summaries:
        return {"overall_evaluation": "E", "evaluation_for_each_clause": []}

    def _evaluate_item(item: Dict) -> Dict:
        category = item.get("category", "기타")
        summary = item.get("summary", "")
        evaluation = evaluate_summary(category, summary, client)
        label = evaluation.get("label", "neutral")
        reasoning = evaluation.get("reasoning", "error")

        return {
            "label": label,
            "result": {
                "evaluation": label,
                "summarized_clause": summary,
                "category": category,
                "reasoning": reasoning,
            },
        }

    labels: List[str] = []
    clause_results: List[Dict] = []
    with ThreadPoolExecutor(max_workers=len(category_summaries)) as executor:
        futures = [executor.submit(_evaluate_item, item) for item in category_summaries]
        for future in as_completed(futures):
            data = future.result()
            labels.append(data["label"])
            clause_results.append(data["result"])

    overall = _calculate_overall_evaluation(labels)

    return {
        "overall_evaluation": overall,
        "evaluation_for_each_clause": clause_results,
    }
